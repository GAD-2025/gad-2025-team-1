<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 관리 - creAItive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/gad-2025-team-1/frontend/style/myspace.css">
    
    <style>
        /* --- 기존 스타일 확장 --- */
        .manage-container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; color: #333; }
        .manage-title { font-size: 2rem; font-weight: bold; margin-bottom: 30px; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .manage-card { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .section-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* 기본 정보 */
        .basic-info-grid { display: flex; gap: 40px; align-items: center; }
        .profile-img-edit { position: relative; width: 150px; height: 150px; flex-shrink: 0;}
        .profile-img-preview { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #FF5900; }
        .btn-img-upload { position: absolute; bottom: 5px; right: 5px; background: #333; color: #fff; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .input-group { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .form-input, .form-textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .form-textarea { resize: none; height: 80px; }

        /* 폴더 관리 스타일 */
        .folder-list { display: flex; flex-direction: column; gap: 10px; }
        .folder-item-edit { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .folder-item-edit:hover { background: #fff3e0; border-color: #FF5900; }
        .item-info { display: flex; align-items: center; gap: 15px; }
        .item-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #ddd; }

        /* 대표 작품 (Orbit) 그리드 스타일 */
        .orbit-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
        .orbit-item { position: relative; aspect-ratio: 1/1; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .orbit-item img { width: 100%; height: 100%; object-fit: cover; }
        
        /* 삭제 버튼 (호버시 등장) */
        .btn-delete-orbit { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; opacity: 0; transition: 0.2s; cursor: pointer; border: none; }
        .orbit-item:hover .btn-delete-orbit { opacity: 1; }

        /* 추가 버튼 */
        .orbit-add-btn { aspect-ratio: 1/1; border-radius: 10px; border: 2px dashed #ccc; background: #f9f9f9; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 2rem; color: #ccc; transition: 0.2s; }
        .orbit-add-btn:hover { border-color: #FF5900; color: #FF5900; background: #fff; }

        /* 모달 (팝업) 스타일 */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        /* 이미지 선택 그리드 (모달 내부) */
        .image-picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .pick-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .pick-img:hover { border-color: #FF5900; opacity: 0.8; }

        .action-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 40px; }
        .btn-action { padding: 12px 40px; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border: none; }
        .btn-save { background-color: #FF5900; color: white; }
        .btn-cancel { background-color: #ddd; color: #333; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-section header-left">
           <a href="/gad-2025-team-1/frontend/pages/explore.html" class="header-logo"><span style="color: #FF5900;">creAItive</span></a>
        </div>
      <nav class="header-section header-center">
            <ul class="header-menu">
                <li><a href="#">거래하기</a></li>
                <li><a href="#">작품보관함</a></li>
                <li><a href="#" class="active">마이 스페이스</a></li>
                <li><a href="#">설정</a></li>
            </ul>
        </nav>
        <div class="header-section header-right">
            <div class="user-profile-widget">
                <img src="" alt="프로필" class="widget-profile-img user-img-target">
                <div class="widget-info">
                    <span class="widget-user-name user-name-target"></span>
                    <span class="widget-badge-buyer">구매자</span>
                </div>
            </div>
        </div>
    </header>

    <main class="myspace-container">
        <div class="manage-container">
            <h2 class="manage-title">프로필 관리</h2>

            <section class="manage-card">
                <div class="section-title">기본 정보</div>
                <div class="basic-info-grid">
                    <div class="profile-img-edit">
                        <img src="" alt="프로필" class="profile-img-preview user-img-target" id="previewImg">
                        <label for="fileInput" class="btn-img-upload"><i class="fas fa-camera"></i></label>
                        <input type="file" id="fileInput" style="display: none;" accept="image/*">
                    </div>
                    <div class="input-group">
                        <div><label>이름</label><input type="text" class="form-input" id="inputName"></div>
                        <div><label>한줄 소개</label><textarea class="form-textarea" id="inputBio"></textarea></div>
                    </div>
                </div>
            </section>

            <section class="manage-card">
                <div class="section-title">아카이빙 폴더 관리 <small style="font-weight:normal; font-size:0.8rem; color:#888;">(클릭하여 내용 편집)</small></div>
                <div class="folder-list" id="folderListArea">
                    </div>
            </section>

            <section class="manage-card">
                <div class="section-title">대표 작품 관리 (Orbit) <small style="font-weight:normal; font-size:0.8rem; color:#888;">(마우스를 올려 삭제)</small></div>
                <div class="orbit-grid" id="orbitGridArea">
                    </div>
            </section>

            <div class="action-buttons">
                <button class="btn-action btn-cancel" onclick="history.back()">취소</button>
                <button class="btn-action btn-save" onclick="saveAllData()">저장하고 적용하기</button>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="imagePickerModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">작품 선택</span>
                <button class="modal-close" onclick="closeModal('imagePickerModal')">&times;</button>
            </div>
            <div class="image-picker-grid" id="pickerGrid">
                </div>
        </div>
    </div>

    <div class="modal-overlay" id="folderEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="folderEditTitle">폴더 편집</span>
                <button class="modal-close" onclick="closeModal('folderEditModal')">&times;</button>
            </div>
            <p style="margin-bottom:10px;">폴더 내 작품:</p>
            <div class="orbit-grid" id="folderWorksGrid" style="grid-template-columns: repeat(3, 1fr);"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // --- 1. 초기 데이터 설정 (Local Storage가 비어있을 경우) ---
        const defaultData = {
            name: "김민지",
            bio: "창작을 좋아하는 열정가득 대학생입니다",
            img: "/gad-2025-team-1/frontend/images/White Cats.jpg",
            folders: [
                { id: 1, name: "WISH", thumb: "/gad-2025-team-1/frontend/images/folder_1.jpg", works: [] },
                { id: 2, name: "My Work", thumb: "/gad-2025-team-1/frontend/images/folder_2.jpg", works: [] },
                { id: 3, name: "ART", thumb: "/gad-2025-team-1/frontend/images/folder_3.jpg", works: [] }
            ],
            orbit: [
                "/gad-2025-team-1/frontend/images/art_5.jpg",
                "/gad-2025-team-1/frontend/images/art_6.jpg",
                "/gad-2025-team-1/frontend/images/art_7.jpg",
                "/gad-2025-team-1/frontend/images/art_1.jpg",
                "/gad-2025-team-1/frontend/images/art_2.jpg"
            ]
        };

        // 더미 이미지 리스트 (작품 추가 시 선택용)
        const availableImages = [
            "/gad-2025-team-1/frontend/images/art_1.jpg", "/gad-2025-team-1/frontend/images/art_2.jpg",
            "/gad-2025-team-1/frontend/images/art_3.jpg", "/gad-2025-team-1/frontend/images/art_4.jpg",
            "/gad-2025-team-1/frontend/images/art_5.jpg", "/gad-2025-team-1/frontend/images/art_6.jpg",
            "/gad-2025-team-1/frontend/images/art_7.jpg", "/gad-2025-team-1/frontend/images/White Cats.jpg"
        ];

        // 로컬 스토리지에서 데이터 로드
        let myData = JSON.parse(localStorage.getItem('myspaceData')) || defaultData;
        let currentEditingFolderId = null; // 현재 편집중인 폴더 ID

        $(document).ready(function() {
            renderAll();
        });

        function renderAll() {
            // 기본 정보 렌더링
            $('#inputName').val(myData.name);
            $('#inputBio').val(myData.bio);
            $('.user-img-target').attr('src', myData.img);
            $('.user-name-target').text(myData.name);

            // 폴더 리스트 렌더링
            const $folderList = $('#folderListArea');
            $folderList.empty();
            myData.folders.forEach(folder => {
                $folderList.append(`
                    <div class="folder-item-edit" onclick="openFolderEdit(${folder.id})">
                        <div class="item-info">
                            <img src="${folder.thumb}" class="item-thumb">
                            <span style="font-weight:bold;">${folder.name}</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                    </div>
                `);
            });

            // 대표 작품 (Orbit) 렌더링
            const $orbitGrid = $('#orbitGridArea');
            $orbitGrid.empty();
            myData.orbit.forEach((imgUrl, index) => {
                $orbitGrid.append(`
                    <div class="orbit-item">
                        <img src="${imgUrl}">
                        <button class="btn-delete-orbit" onclick="deleteOrbitWork(${index})">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                `);
            });
            // 추가 버튼
            $orbitGrid.append(`<div class="orbit-add-btn" onclick="openPicker('orbit')"><i class="fas fa-plus"></i></div>`);
        }

        // --- 기능 함수들 ---

        // 1. 이미지 업로드 미리보기
        $("#fileInput").change(function() {
            if (this.files && this.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    myData.img = e.target.result; // 데이터 URL로 저장
                    renderAll(); // 즉시 반영
                }
                reader.readAsDataURL(this.files[0]);
            }
        });

        // 2. 대표 작품 삭제
        function deleteOrbitWork(index) {
            if(confirm('이 작품을 궤도에서 내리시겠습니까?')) {
                myData.orbit.splice(index, 1);
                renderAll();
            }
        }

        // 3. 폴더 편집 열기
        function openFolderEdit(folderId) {
            currentEditingFolderId = folderId;
            const folder = myData.folders.find(f => f.id === folderId);
            $('#folderEditTitle').text(`'${folder.name}' 폴더 관리`);
            
            renderFolderWorks(folder);
            $('#folderEditModal').addClass('active');
        }

        function renderFolderWorks(folder) {
            const $grid = $('#folderWorksGrid');
            $grid.empty();
            
            // 폴더 내 작품들
            folder.works.forEach((work, idx) => {
                $grid.append(`
                    <div class="orbit-item">
                        <img src="${work}">
                        <button class="btn-delete-orbit" onclick="deleteFolderWork(${idx})">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                `);
            });
            // 폴더 내 추가 버튼
            $grid.append(`<div class="orbit-add-btn" onclick="openPicker('folder')"><i class="fas fa-plus"></i></div>`);
        }

        function deleteFolderWork(idx) {
            const folder = myData.folders.find(f => f.id === currentEditingFolderId);
            folder.works.splice(idx, 1);
            renderFolderWorks(folder);
        }

        // 4. 작품 선택 모달 (공용)
        let pickerMode = ''; // 'orbit' or 'folder'

       // profile_manage.html 하단 스크립트 수정

// 1. 피커(이미지 선택창) 열기 함수 수정
function openPicker(mode) {
    pickerMode = mode;
    
    // [수정 핵심] 만약 폴더 편집 중이었다면, 폴더 모달을 잠시 숨깁니다.
    if (mode === 'folder') {
        $('#folderEditModal').removeClass('active'); // 폴더 모달 숨김
    }

    const $grid = $('#pickerGrid');
    $grid.empty();
    availableImages.forEach(src => {
        $grid.append(`<img src="${src}" class="pick-img" onclick="pickImage('${src}')">`);
    });
    
    $('#imagePickerModal').addClass('active'); // 이미지 선택 모달 열기
}

// 2. 이미지 선택 완료 함수 수정
function pickImage(src) {
    if (pickerMode === 'orbit') {
        myData.orbit.push(src);
        renderAll();
        closeModal('imagePickerModal'); // 오비트는 그냥 닫으면 끝
    } 
    else if (pickerMode === 'folder') {
        const folder = myData.folders.find(f => f.id === currentEditingFolderId);
        folder.works.push(src);
        
        // 이미지 선택 모달 닫기
        closeModal('imagePickerModal');

        // [수정 핵심] 숨겼던 폴더 편집 모달을 다시 열어서 결과를 보여줍니다.
        // 데이터가 변경되었으니 renderFolderWorks로 화면을 갱신해서 다시 띄웁니다.
        renderFolderWorks(folder);
        $('#folderEditModal').addClass('active'); 
    }
}

// (참고) 취소하고 닫기 버튼을 눌렀을 때를 대비해 로직 추가
function closeModal(modalId) {
    $('#' + modalId).removeClass('active');
    
    // 만약 이미지 선택창을 그냥 닫았는데(X버튼), 모드가 'folder'였다면 
    // 다시 폴더 모달을 띄워줘야 사용자가 길을 잃지 않습니다.
    if (modalId === 'imagePickerModal' && pickerMode === 'folder') {
         // 단순히 닫기만 한 경우에도 폴더 모달 복귀가 필요하다면 아래 주석 해제
         // $('#folderEditModal').addClass('active'); 
    }
}

        function closeModal(id) {
            $('#' + id).removeClass('active');
        }

        // --- 최종 저장 ---
        function saveAllData() {
            myData.name = $('#inputName').val();
            myData.bio = $('#inputBio').val();
            
            localStorage.setItem('myspaceData', JSON.stringify(myData));
            alert('저장되었습니다! 마이 스페이스로 이동합니다.');
            // 실제 경로에 맞게 수정 필요
            location.href = 'myspace.html'; // 원래 페이지로 이동
        }
    </script>
</body>
</html>